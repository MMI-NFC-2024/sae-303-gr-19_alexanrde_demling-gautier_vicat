<div class="flex flex-col items-center">
  <div id="vulnerabilityMap" class="w-full max-w-6xl h-[700px]"></div>
</div>

<script client:load>
  (async () => {
    const [vulRes, franceRes] = await Promise.all([
      fetch("/data/vulnerability.json"),
      fetch("/data/france.geojson")
    ]);
    const vulnerability = await vulRes.json();
    const france = await franceRes.json();

    const chart = Plot.plot({
      title: "Indice global de vulnérabilité sanitaire par département",
      subtitle: "Combinaison : pauvreté, chômage, âge et accessibilité médicale (APL).",
      height: 650,
      margin: 0,
      inset: 8,
      x: { axis: null },
      y: { axis: null },
      color: {
        type: "linear",
        scheme: "RdBu",
        reverse: true,
        label: "Score (rouge = plus vulnérable, bleu = moins vulnérable)",
        legend: true
      },
      marks: [
        Plot.geo(france, {
          projection: "mercator",
          fill: (d) => {
            const code = String(d.properties.code).padStart(2, "0");
            const row = vulnerability.find((x) => x.code_departement === code);
            return row ? row.score : NaN;
          },
          stroke: "white",
          strokeWidth: 0.7,
          title: (d) => {
            const code = String(d.properties.code).padStart(2, "0");
            const row = vulnerability.find((x) => x.code_departement === code);
            return row
              ? `${d.properties.nom}\nIndice de vulnérabilité : ${row.score.toFixed(2)}`
              : `${d.properties.nom}\nAucune donnée`;
          }
        })
      ]
    });

    document.getElementById("vulnerabilityMap").append(chart);
  })();
</script>
